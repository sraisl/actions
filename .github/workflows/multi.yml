name: Bulk Branch Creator

on:
  # Ermöglicht den manuellen Start des Workflows über die GitHub-Oberfläche
  workflow_dispatch:
    inputs:
      repos_list:
        description: 'Komma-separierte Liste der Repositories (z.B. repo-api, repo-web)'
        required: true
        type: string
      new_branch_name:
        description: 'Name des neuen Branches, der erstellt werden soll'
        required: true
        type: string
      base_branch:
        description: 'Basis-Branch, von dem aus der neue Branch erstellt wird (z.B. main oder develop)'
        required: true
        default: 'main'

jobs:
  create_branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: Konfiguriere Umgebungsvariablen
        run: |
          # Setze Organisation und Branch-Namen als Umgebungsvariablen für das Skript
          echo "ORG=${{ github.repository_owner }}" >> $GITHUB_ENV
          echo "NEW_BRANCH=${{ github.event.inputs.new_branch_name }}" >> $GITHUB_ENV
          echo "BASE_BRANCH=${{ github.event.inputs.base_branch }}" >> $GITHUB_ENV

      # Da gh CLI oft vorinstalliert ist, kann der separate Installationsschritt entfallen.
      # Wir verwenden direkt die gh-Befehle im nächsten 'run' Schritt.
      
      - name: Repositories durchlaufen und Branch erstellen
        env:
          # Der GITHUB_TOKEN wird für die Authentifizierung der API-Aufrufe benötigt
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Die kommagetrennte Liste in eine zeilenbasierte Liste umwandeln
          REPOS_ARRAY=$(echo "${{ github.event.inputs.repos_list }}" | tr ',' '\n')
          
          echo "Starte Branch-Erstellung für Organisation: $ORG"
          echo "Neuer Branch: $NEW_BRANCH (Basis: $BASE_BRANCH)"
          
          # Durchlaufe jedes Repository in der Liste
          for REPO_NAME in $REPOS_ARRAY; do
            REPO_NAME=$(echo "$REPO_NAME" | xargs) # Führende/nachfolgende Leerzeichen entfernen
            REPO_SLUG="${ORG}/${REPO_NAME}"

            echo "--- Bearbeite ${REPO_SLUG} ---"

            # 1. Abrufen der SHA des Basis-Branches (erforderlich für die API)
            SHA=$(gh api repos/${REPO_SLUG}/branches/${BASE_BRANCH} --jq '.commit.sha' 2>/dev/null)
            
            if [ -z "$SHA" ] || [ "$SHA" == "null" ]; then
                echo "❌ FEHLER: Basis-Branch ${BASE_BRANCH} in ${REPO_NAME} nicht gefunden oder kein Zugriff."
                continue
            fi
            
            # 2. Erstellen der neuen Branch-Referenz über die Git-API
            # Die API-Methode POST /git/refs erstellt einen neuen Branch (ref/heads/...)
            gh api --method POST \
                -H "Accept: application/vnd.github.v3+json" \
                /repos/${REPO_SLUG}/git/refs \
                -f ref="refs/heads/${NEW_BRANCH}" \
                -f sha="$SHA" 2>&1 | tee output.log

            # Prüfen des Ergebnisses
            if grep -q "201 Created" output.log; then
                echo "✅ Branch ${NEW_BRANCH} erfolgreich erstellt."
            elif grep -q "Reference already exists" output.log; then
                echo "⚠️ Branch ${NEW_BRANCH} existiert bereits."
            else
                echo "❌ Unbekannter Fehler beim Erstellen des Branches. Siehe output.log."
            fi
            rm -f output.log
          done

          echo "--- Vorgang abgeschlossen ---"
